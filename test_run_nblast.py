import json
import os
import navis
from unittest import TestCase

from run_nblast import nblast_all_by_all, nblast_list_to_list, nblast_id_pair, load_dp, nblast_dp_pair


def find_swcs(folder):
    files = []
    for fname in sorted(os.listdir(folder)):
        if fname.endswith(".swc"):
            files.append(fname.split(".")[0])
    print(f"Found {len(files)} swc files in {folder}")
    return files

class Test(TestCase):
    def test_consistency(self):
        files_l2 = find_swcs("swc_l2")
        files_lod1 = find_swcs("swc_lod1")

        files_inter = set(files_lod1).intersection(files_l2)
        print(f"Intersection: {len(files_inter)} swc files")

        similar_cell_ids = [720575940632852124,720575940626390018,720575940627514627,720575940621624491,720575940621089741,720575940609617614,720575940636592270,720575940636734382,720575940638642547,720575940609030776,720575940627947772,720575940619559838,720575940612033253,720575940624710653]
        similar_cell_ids = [str(rid) for rid in similar_cell_ids]
        similar_cell_ids = files_inter.intersection(similar_cell_ids)
        self.assertEqual(13, len(similar_cell_ids))

        # check that the two endpoints/methods produce same results
        for folder in ["swc_l2", "swc_lod1"]:
            res_w = nblast_all_by_all(similar_cell_ids, folder, min_score=-0.5)
            res_d = nblast_list_to_list(similar_cell_ids, similar_cell_ids, folder, folder, min_score=-0.5)
            for k in list(res_w.keys()) + list(res_w.keys()):
                self.assertTrue(k[0] in similar_cell_ids)
                self.assertTrue(k[1] in similar_cell_ids)
            self.assertEqual(sorted(res_d.items()), sorted(res_w.items()), folder)

        # check that NBLASTing different resolutions make sense
        for rid in similar_cell_ids:
            sc = nblast_id_pair(rid, rid, "swc_l2", "swc_lod1")
            print(f"{rid}: {sc}")

    def test_batch_nblast(self):
        fw_rids = {
            "adt": [720575940614309535,720575940603231916,720575940605102694,720575940613345442,720575940619385765,720575940621185050,720575940623543881,720575940626034819,720575940637208718,720575940637469254,720575940604407468,720575940617229632,720575940621239679,720575940623303108,720575940625641196,720575940630066007,720575940632571583,720575940606550706,720575940608341806,720575940608656942,720575940608903122,720575940611015958,720575940611172465,720575940611672746,720575940611920365,720575940612062426,720575940612768106,720575940612856854,720575940613234591,720575940613458669,720575940613775825,720575940613895934,720575940614714299,720575940615322674,720575940616098644,720575940618005531,720575940618115669,720575940618514555,720575940619453861,720575940619893072,720575940620156513,720575940620441821,720575940621453014,720575940621956869,720575940622224553,720575940622602025,720575940623320649,720575940623886266,720575940625449530,720575940625960360,720575940626172490,720575940626199562,720575940626601994,720575940628121143,720575940628337307,720575940628766415,720575940629106438,720575940629140988,720575940629583345,720575940629684792,720575940629836793,720575940629947439,720575940629963779,720575940631652433,720575940633990039,720575940634391950,720575940636917737,720575940637370175,720575940638227253,720575940638583869,720575940638870360,720575940639010392,720575940641886605,720575940644161815,720575940605648002,720575940607846083,720575940607924828,720575940608212548,720575940610568305,720575940610815510,720575940611114262,720575940611494629,720575940615046450,720575940615792523,720575940615967574,720575940616044834,720575940616987426,720575940617219869,720575940618254809,720575940618535303,720575940619413317,720575940620664496,720575940620874996,720575940621074390,720575940621347092,720575940621579179,720575940621669002,720575940621766035,720575940622386056,720575940623997879,720575940624078484,720575940624105876,720575940624421834,720575940624449573,720575940624850434,720575940624884112,720575940625721610,720575940626000016,720575940626365958,720575940626366982,720575940626649098,720575940626745616,720575940626983185,720575940627388047,720575940627466746,720575940628046851,720575940628121399,720575940628396090,720575940628647823,720575940628750718,720575940628914152,720575940629491275,720575940629944407,720575940629957943,720575940630247784,720575940631445452,720575940631473122,720575940631688955,720575940631761433,720575940631857548,720575940631993415,720575940633873007,720575940633990812,720575940634261172,720575940634724494,720575940634743999,720575940635895774,720575940636063406,720575940637836477,720575940637855104,720575940638630366,720575940639011160,720575940640802675,720575940642878368,720575940644528163,720575940644948771],
            "aip": [720575940612938645,720575940614930363,720575940628599934,720575940637281395,720575940609927141,720575940609927653,720575940610284018,720575940611622002,720575940611694545,720575940611807919,720575940612290986,720575940613518092,720575940613943413,720575940614081909,720575940614310050,720575940616611382,720575940617117656,720575940617574229,720575940618833840,720575940619249031,720575940619853481,720575940621308341,720575940621625607,720575940622609678,720575940622699196,720575940622752041,720575940623730634,720575940623787495,720575940624375324,720575940624514762,720575940624780062,720575940625645128,720575940625701909,720575940625989904,720575940626211472,720575940626568235,720575940626655178,720575940626953063,720575940627174247,720575940627354562,720575940628135675,720575940628426946,720575940628933975,720575940629954724,720575940632590818,720575940632649567,720575940633307729,720575940633353327,720575940634126478,720575940634126949,720575940637282675,720575940638776227,720575940640762275,720575940641359776,720575940645931060,720575940649911286,720575940605137538,720575940607627275,720575940607944260,720575940609083086,720575940610867683,720575940610880149,720575940611554034,720575940615109563,720575940615863638,720575940617028406,720575940617305531,720575940617558246,720575940617900123,720575940618083531,720575940619149702,720575940619784453,720575940619808134,720575940619859532,720575940620719600,720575940621447077,720575940621899016,720575940621958936,720575940622117441,720575940622204925,720575940622510606,720575940622754756,720575940622971911,720575940623021292,720575940623304906,720575940623766458,720575940624211075,720575940624867721,720575940624939337,720575940625011600,720575940625032721,720575940625855004,720575940625871132,720575940626139175,720575940626256003,720575940626269033,720575940626717712,720575940626887080,720575940627174404,720575940627350060,720575940627589126,720575940627952207,720575940628239468,720575940628405366,720575940629065078,720575940629228559,720575940629345398,720575940629852163,720575940629954335,720575940630334828,720575940630744019,720575940630812663,720575940631922969,720575940632040652,720575940632157631,720575940632238253,720575940633682295,720575940634709872,720575940636009950,720575940637371992,720575940639325941,720575940639767693,720575940640889176,720575940641400224,720575940642818852,720575940643245422,720575940645697668,720575940650711798,720575940650973174,720575940651713782,720575940604114604,720575940608268636,720575940609264452,720575940615131567,720575940615865233,720575940619121647,720575940621256682,720575940621556743,720575940622449481,720575940622895911,720575940622969528,720575940623784596,720575940624107751,720575940625384732,720575940625844721,720575940627827450,720575940629088018,720575940629271352,720575940630291070,720575940630707795,720575940630998595,720575940631776855,720575940631913005,720575940632931298,720575940639220550,720575940640714192],
            "asg": [720575940636928398,720575940620588747,720575940620879809,720575940622678781,720575940625082298,720575940627819113,720575940629299018,720575940633564703],
            "asp": [720575940621031629,720575940627984119,720575940611633010,720575940613408552,720575940615606634,720575940616286175,720575940617727793,720575940622364598,720575940623003405,720575940624579100,720575940625502666,720575940627094696,720575940631877944,720575940632821864,720575940637607646,720575940641276045,720575940641553805,720575940652922529,720575940603917158,720575940603930046,720575940604445868,720575940606334338,720575940606411698,720575940608661955,720575940609504210,720575940610558357,720575940611682533,720575940613034602,720575940614190242,720575940614474407,720575940615200059,720575940615201675,720575940615274914,720575940615522922,720575940615592409,720575940617260374,720575940618772719,720575940618878191,720575940619021272,720575940619688688,720575940620203502,720575940620588491,720575940620833974,720575940621694401,720575940621885957,720575940622053185,720575940622727551,720575940623130248,720575940623247300,720575940623256202,720575940623867911,720575940624191181,720575940625597317,720575940627607192,720575940627718394,720575940628837650,720575940629199146,720575940629490476,720575940630087542,720575940630181463,720575940630899560,720575940631263023,720575940631520312,720575940632392599,720575940633033567,720575940634814315,720575940635307256,720575940637106032,720575940639563728,720575940643651784,720575940650920569,720575940603167916,720575940605302974,720575940606774281,720575940606919602,720575940608481860,720575940610125786,720575940612403427,720575940612444645,720575940613400306,720575940613641794,720575940614005958,720575940614167483,720575940614752395,720575940616592523,720575940616597643,720575940616996294,720575940617034398,720575940617290713,720575940617390027,720575940617571997,720575940617859121,720575940618139221,720575940618190727,720575940618252249,720575940618482781,720575940618851425,720575940618965926,720575940618995505,720575940619455448,720575940619583749,720575940619731334,720575940620418684,720575940620422012,720575940620946957,720575940621007384,720575940621433599,720575940621746300,720575940622190550,720575940622270529,720575940622365991,720575940622784660,720575940623249043,720575940623263415,720575940623538951,720575940623984677,720575940624290303,720575940624391816,720575940624535042,720575940624853031,720575940624901927,720575940624925989,720575940625035790,720575940625049607,720575940625170362,720575940625760318,720575940625954853,720575940626220669,720575940626312835,720575940626612888,720575940626754192,720575940626899817,720575940627027087,720575940627277498,720575940627368250,720575940627437841,720575940627600719,720575940627700554,720575940627877570,720575940627976222,720575940628256763,720575940628528377,720575940628542807,720575940628728796,720575940628782824,720575940628915460,720575940628917251,720575940629033977,720575940629130039,720575940629330944,720575940629394232,720575940629431814,720575940629521914,720575940629552170,720575940629573647,720575940629762043,720575940630214564,720575940630245650,720575940630697979,720575940630719173,720575940630940943,720575940631390940,720575940631434541,720575940631525004,720575940631542855,720575940631567129,720575940632013724,720575940632014383,720575940632044172,720575940632609762,720575940632741728,720575940633118637,720575940633429331,720575940633500084,720575940633801261,720575940634284399,720575940634460055,720575940634695263,720575940635118943,720575940635159476,720575940635515572,720575940635565816,720575940636004836,720575940636053594,720575940636092590,720575940636367076,720575940636504553,720575940637175349,720575940637416078,720575940637832937,720575940638046948,720575940638890355,720575940639012836,720575940639053146,720575940639686973,720575940641323405,720575940641348237,720575940641972384,720575940643118733,720575940643300974,720575940644319796,720575940647020932,720575940650885497,720575940652114422,720575940655000737,720575940604838432,720575940605013420,720575940605041324,720575940605676576,720575940606161586,720575940606682302,720575940606745190,720575940607915529,720575940608588555,720575940608755042,720575940608964821,720575940609240515,720575940611942371,720575940614618741,720575940614674082,720575940614701730,720575940615474875,720575940616292165,720575940616766182,720575940618128433,720575940618268376,720575940618988678,720575940619047547,720575940619496641,720575940620146141,720575940620204166,720575940620577612,720575940620848086,720575940620897389,720575940621308656,720575940621354416,720575940621433641,720575940621922086,720575940622165974,720575940622525654,720575940623083519,720575940623311630,720575940623836967,720575940624326448,720575940624345136,720575940624403239,720575940624562469,720575940625007879,720575940625952002,720575940626417801,720575940626579466,720575940626607930,720575940626709373,720575940627062184,720575940627575573,720575940628506641,720575940628533036,720575940629328502,720575940629761591,720575940630012716,720575940630027372,720575940630158140,720575940630214782,720575940632261423,720575940633254370,720575940633317713,720575940633743796,720575940634062803,720575940634757601,720575940635508404,720575940635733172,720575940635960292,720575940636174960,720575940638245464,720575940639366478,720575940639533008,720575940639828595,720575940641006299,720575940641181136,720575940641181392,720575940641627099,720575940650976502,720575940654929057],
            "pip": [720575940624407944,720575940609321938,720575940609779465,720575940610505957,720575940612364697,720575940615790310,720575940616566996,720575940619689920,720575940619984731,720575940622207997,720575940623232392,720575940625336556,720575940625498376,720575940626705029,720575940629243904,720575940630046511,720575940630143116,720575940630191447,720575940630492191,720575940630546302,720575940630992813,720575940632303772,720575940632698519,720575940634362835,720575940640204477,720575940642447349,720575940659392129,720575940604160172,720575940607447491,720575940609330033,720575940610387825,720575940611332325,720575940616039510,720575940616670016,720575940617026587,720575940619449588,720575940619820368,720575940620402712,720575940621330893,720575940621331405,720575940621452526,720575940621737992,720575940622932487,720575940623860458,720575940624676071,720575940624786954,720575940625742681,720575940625894799,720575940627745895,720575940628195522,720575940628632057,720575940629414987,720575940629504262,720575940629514296,720575940629517051,720575940629822604,720575940631160787,720575940633668020,720575940635445360,720575940636151871,720575940636265188,720575940638482421,720575940642533156,720575940603942828,720575940604692354,720575940607103241,720575940611961878,720575940617856832,720575940618073024,720575940618534721,720575940618721968,720575940618723504,720575940621178444,720575940621386017,720575940622105480,720575940622148391,720575940622633364,720575940623008136,720575940623827533,720575940624131736,720575940624299534,720575940624735463,720575940624922910,720575940625410888,720575940625783897,720575940625904414,720575940626654041,720575940629245903,720575940629512248,720575940629592143,720575940629650540,720575940632102607,720575940637146813,720575940639747469],
            "pmp": [720575940615692690,720575940620582260,720575940630221509,720575940621031006,720575940626859283,720575940607632579,720575940610850838,720575940612153041,720575940612572054,720575940613219946,720575940613403890,720575940614363619,720575940616614946,720575940618413295,720575940621325150,720575940621387155,720575940621463334,720575940621971316,720575940622319715,720575940622532595,720575940622536179,720575940622617748,720575940622934711,720575940623719568,720575940623808805,720575940624908440,720575940625071114,720575940625278820,720575940625858536,720575940626775824,720575940626962435,720575940627517442,720575940629020357,720575940629285879,720575940606028210,720575940606335410,720575940606998485,720575940611174067,720575940611724517,720575940612808086,720575940612888231,720575940613871046,720575940615051473,720575940615763174,720575940616747934,720575940617091890,720575940617779029,720575940618057095,720575940618741157,720575940618836801,720575940619602928,720575940620633309,720575940621333669,720575940621388947,720575940622384311,720575940622530547,720575940623438460,720575940623558152,720575940623796272,720575940624379394,720575940624430364,720575940624535554,720575940625073801,720575940625965820,720575940626158598,720575940626850603,720575940628244055,720575940630059335,720575940630085480,720575940630253928,720575940630500004,720575940630570577,720575940630650655,720575940631245372,720575940631579219,720575940631915801,720575940632778051,720575940632843455,720575940633113195,720575940633590167,720575940634349281,720575940634504303,720575940635196334,720575940636211945,720575940638285184,720575940638719907,720575940638775640,720575940640696539,720575940641293301,720575940642866199,720575940643296968,720575940608663253,720575940612711958,720575940613824278,720575940621038294,720575940621426300,720575940623151357,720575940627713284,720575940627976088,720575940629198636,720575940631466783,720575940631554627,720575940633156377],
            "psg": [720575940617184001,720575940621633683,720575940603944382,720575940633715831],
            "psp": [720575940616551029,720575940612490958,720575940621744116,720575940622151704,720575940623396548,720575940626965258,720575940628003304,720575940632311115,720575940636256319,720575940605420674,720575940606563249,720575940608749525,720575940608901333,720575940611514261,720575940612619431,720575940613338690,720575940614043699,720575940614047026,720575940615257823,720575940615663466,720575940615668370,720575940615896806,720575940616004146,720575940617878273,720575940618162773,720575940618887838,720575940619197366,720575940619930021,720575940621356470,720575940622027527,720575940622213953,720575940622366221,720575940622963127,720575940623393357,720575940624017812,720575940624734512,720575940624743096,720575940624934787,720575940624977930,720575940625681681,720575940626230780,720575940627310602,720575940627592977,720575940627987279,720575940628190663,720575940628795413,720575940629105563,720575940629347319,720575940629467692,720575940629939499,720575940630292439,720575940631143213,720575940631260476,720575940631371991,720575940631586924,720575940633304913,720575940633994391,720575940635515744,720575940637067888,720575940637975615,720575940638879651,720575940639733923,720575940639751376,720575940640877400,720575940643463584,720575940645129524,720575940648397177,720575940659760769,720575940602849248,720575940604821950,720575940605024684,720575940605040300,720575940608093449,720575940608606475,720575940609642505,720575940610457457,720575940610623186,720575940610676834,720575940610980245,720575940611376346,720575940611505394,720575940612079845,720575940612291682,720575940612982191,720575940612983445,720575940613234838,720575940613786786,720575940614281578,720575940615513410,720575940615898086,720575940616946900,720575940618792686,720575940618966464,720575940619113557,720575940619846497,720575940619865941,720575940619923371,720575940620096065,720575940620158447,720575940621045765,720575940621075482,720575940621895382,720575940622080865,720575940622172540,720575940622195376,720575940622625485,720575940622768408,720575940623299623,720575940623370421,720575940623547114,720575940623555047,720575940623920821,720575940624007207,720575940624651704,720575940625375490,720575940625776272,720575940625803018,720575940626132030,720575940626326121,720575940627386698,720575940627599815,720575940628131371,720575940628923907,720575940629432394,720575940629765314,720575940629914732,720575940630003195,720575940630092406,720575940630171708,720575940630318695,720575940630357110,720575940630402834,720575940630644807,720575940630913105,720575940631320168,720575940631912040,720575940632133857,720575940632672156,720575940633286335,720575940634003027,720575940634911589,720575940635033023,720575940635146359,720575940635157902,720575940637285951,720575940637559182,720575940637861294,720575940638064959,720575940638128573,720575940638131534,720575940638673478,720575940639164323,720575940639926360,720575940643305672],
        }
        dp_cache = {}
        def get_dp(rid, folder):
            if (rid, folder) not in dp_cache:
                dp_cache[(rid, folder)] = load_dp(rid, folder)
            return dp_cache[(rid, folder)]

        cachero_swcs = find_swcs("swc_cachero")
        for cid1 in cachero_swcs:
            cdp1 = get_dp(cid1, "swc_cachero")
            for cid2 in cachero_swcs:
                cdp2 = get_dp(cid2, "swc_cachero")
                sc = nblast_dp_pair(cdp1, cdp2)
                if sc > 0:
                    print(f"{cid1}, {cid2}: {sc}")

        """
        for cid in cachero_swcs:
            cdp = get_dp(cid, "swc_cachero")
            for pfx, rids in fw_rids.items():
                for rid in rids:
                    rid = str(rid)
                    rdp = get_dp(rid, "swc_lod1")
                    sc = nblast_dp_pair(cdp, rdp)
                    print(f"{cid}, {pfx}-{rid}: {sc}")
                    
        """

    def test_visualize(self):
        cachero_swcs = find_swcs("swc_cachero")
        cachero_swcs = [c for c in cachero_swcs if c.lower().startswith("adt")]
        skels_cach = [navis.read_swc(f"swc_cachero/{rid}.swc") for rid in cachero_swcs[:5]]
        adt_rids = [720575940614309535,720575940603231916,720575940605102694,720575940613345442,720575940619385765,720575940621185050,720575940623543881,720575940626034819,720575940637208718,720575940637469254,720575940604407468,720575940617229632,720575940621239679,720575940623303108,720575940625641196,720575940630066007,720575940632571583,720575940606550706,720575940608341806,720575940608656942,720575940608903122,720575940611015958,720575940611172465,720575940611672746,720575940611920365,720575940612062426,720575940612768106,720575940612856854,720575940613234591,720575940613458669,720575940613775825,720575940613895934,720575940614714299,720575940615322674,720575940616098644,720575940618005531,720575940618115669,720575940618514555,720575940619453861,720575940619893072,720575940620156513,720575940620441821,720575940621453014,720575940621956869,720575940622224553,720575940622602025,720575940623320649,720575940623886266,720575940625449530,720575940625960360,720575940626172490,720575940626199562,720575940626601994,720575940628121143,720575940628337307,720575940628766415,720575940629106438,720575940629140988,720575940629583345,720575940629684792,720575940629836793,720575940629947439,720575940629963779,720575940631652433,720575940633990039,720575940634391950,720575940636917737,720575940637370175,720575940638227253,720575940638583869,720575940638870360,720575940639010392,720575940641886605,720575940644161815,720575940605648002,720575940607846083,720575940607924828,720575940608212548,720575940610568305,720575940610815510,720575940611114262,720575940611494629,720575940615046450,720575940615792523,720575940615967574,720575940616044834,720575940616987426,720575940617219869,720575940618254809,720575940618535303,720575940619413317,720575940620664496,720575940620874996,720575940621074390,720575940621347092,720575940621579179,720575940621669002,720575940621766035,720575940622386056,720575940623997879,720575940624078484,720575940624105876,720575940624421834,720575940624449573,720575940624850434,720575940624884112,720575940625721610,720575940626000016,720575940626365958,720575940626366982,720575940626649098,720575940626745616,720575940626983185,720575940627388047,720575940627466746,720575940628046851,720575940628121399,720575940628396090,720575940628647823,720575940628750718,720575940628914152,720575940629491275,720575940629944407,720575940629957943,720575940630247784,720575940631445452,720575940631473122,720575940631688955,720575940631761433,720575940631857548,720575940631993415,720575940633873007,720575940633990812,720575940634261172,720575940634724494,720575940634743999,720575940635895774,720575940636063406,720575940637836477,720575940637855104,720575940638630366,720575940639011160,720575940640802675,720575940642878368,720575940644528163,720575940644948771]
        skels_fw = [navis.read_swc(f"swc_lod1/{rid}.swc") for rid in adt_rids[:5]]
        navis.plot3d(skels_cach + skels_fw).show()


